name: Publish libraries

on:
  push:
    tags:
      - libs/*/v*

env:
  PNPM_VERSION: 10.9.0
  NODE_VERSION: 24

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: publishing
    permissions:
      contents: read 
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - run: pnpm install

      - name: Debug git state (temporary)
        # prints HEAD/ref info so you can confirm detached vs attached HEAD in CI
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_REF_NAME=${GITHUB_REF_NAME}"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          git rev-parse --abbrev-ref HEAD || true
          git status --porcelain --branch || true
          git show-ref --heads || true
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Derive package info
        id: pkg
        run: |
          # tag format: libs/<dir>/vX.Y.Z
          TAG="${GITHUB_REF_NAME}"
          PKG_DIR="$(dirname "${TAG}")"          # libs/common-types
          VERSION="${TAG##*/}"                   # v0.1.0
          PKG_NAME=$(jq -r '.name' "${PKG_DIR}/package.json")
          echo "pkg_dir=${PKG_DIR}" >> $GITHUB_OUTPUT
          echo "pkg_name=${PKG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build
        run: pnpm --filter "${{ steps.pkg.outputs.pkg_name }}" build

      - name: Publish
        env:
          NPM_CONFIG_PROVENANCE: true
        run: pnpm --filter "${{ steps.pkg.outputs.pkg_name }}" exec npm publish --provenance --access public
